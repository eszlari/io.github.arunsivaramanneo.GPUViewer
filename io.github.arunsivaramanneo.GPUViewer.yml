id: io.github.arunsivaramanneo.GPUViewer
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: "20.08"
finish-args:
  - --device=all # OpenCL requires /dev/nvidia-uvm
  - --share=ipc
  - --socket=x11
  - --socket=wayland
command: gpu-viewer
cleanup:
  - "*.a"
  - "*.la"
  - /include
  - /lib/pkgconfig
modules:
  - name: gpu-viewer
    buildsystem: simple
    build-commands:
      - mkdir -p /app/{bin,share}
      - cp -a . /app/share/gpu-viewer
      - install -Dm755 gpu-viewer.sh /app/bin/gpu-viewer
      - install -Dm644 Images/GPU_Viewer.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - install -Dm644 gpu-viewer.desktop /app/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --remove-key=Terminal  --remove-key=version /app/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Terminal --set-value=false /app/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Exec --set-value=gpu-viewer /app/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} /app/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 -t /app/share/appdata ${FLATPAK_ID}.appdata.xml
    sources:
      - type: archive
        url: "https://github.com/arunsivaramanneo/GPU-Viewer/archive/v1.15.tar.gz"
        sha256: 366abf2322b6c4dd9852b3352cfbe397b4481bf2fc8f210813cede98bc19fcf5
      - type: script
        dest-filename: gpu-viewer.sh
        commands:
          - cd /app/share/gpu-viewer/Files
          - exec python3 ./GPUViewer.py $@
      - type: file
        path: io.github.arunsivaramanneo.GPUViewer.appdata.xml
    modules:
      - name: vulkan-tools
        buildsystem: cmake-ninja
        config-opts:
          - -DGLSLANG_INSTALL_DIR=/app
          - -DVULKAN_HEADERS_INSTALL_DIR=/app
          - -DCMAKE_BUILD_TYPE=Release
        sources:
          - type: git
            url: https://github.com/KhronosGroup/Vulkan-Tools.git
            commit: 1abaced34b84831f60226ce67a702b2d841e1d87
            tag: v1.2.156
        modules:
          - name: glslang
            buildsystem: cmake-ninja
            config-opts:
              - -DBUILD_SHARED_LIBS=ON
            sources:
              - type: git
                url: https://github.com/KhronosGroup/glslang.git
                commit: bcf6a2430e99e8fc24f9f266e99316905e6d5134
                tag: '8.13.3743'

          - name: vulkan-headers
            buildsystem: cmake-ninja
            sources:
              - type: git
                url: https://github.com/KhronosGroup/Vulkan-Headers.git
                commit: 94ff600cc8623a2fd270cc14b14def3fca12ffaf
                tag: v1.2.156

      - name: mesa-demos
        config-opts:
          - --bindir=/app/lib/mesa-demos
        post-install:
          - mv -v /app/lib/mesa-demos/*info /app/bin/
        sources:
          - type: archive
            url: "https://mesa.freedesktop.org/archive/demos/8.3.0/mesa-demos-8.3.0.tar.bz2"
            sha256: c173154bbd0d5fb53d732471984def42fb1b14ac85fcb834138fb9518b3e0bef
        cleanup:
          - /lib/mesa-demos
        modules:
          - shared-modules/glew/glew.json
          - shared-modules/glu/glu-9.0.0.json

          - name: freeglut
            buildsystem: cmake-ninja
            config-opts:
              - -DCMAKE_INSTALL_LIBDIR=/app/lib
              - -DOpenGL_GL_PREFERENCE=LEGACY
            build-options:
              cflags: -fcommon
              cxxflags: -fcommon
            sources:
              - type: archive
                url: https://downloads.sourceforge.net/project/freeglut/freeglut/3.2.1/freeglut-3.2.1.tar.gz
                sha256: d4000e02102acaf259998c870e25214739d1f16f67f99cb35e4f46841399da68

      - name: clinfo
        no-autogen: true
        no-make-install: true
        build-commands:
          - install -Dm755 -t /app/bin/ clinfo
        sources:
          - type: archive
            url: "https://github.com/Oblomov/clinfo/archive/2.2.18.04.06.tar.gz"
            sha256: f77021a57b3afcdebc73107e2254b95780026a9df9aa4f8db6aff11c03f0ec6c
        modules:
          - name: ocl-icd
            sources:
              - type: git
                url: https://github.com/OCL-dev/ocl-icd.git
                commit: 3b7ded60ebb7e1afddcbae6f82ac8645b276e358
                tag: v2.2.13
              - type: script
                dest-filename: autogen.sh
                commands:
                  - autoreconf -fiv
          - name: opencl-headers
            buildsystem: simple
            build-commands:
              - cp -av opencl22/CL /app/include
            sources:
              - type: git
                url: https://github.com/KhronosGroup/OpenCL-Headers.git
                commit: b04034a17e214322772c19e7ccd2adf0cd306920
                tag: v2020.06.16

      - name: pygobject
        buildsystem: meson
        sources:
          - type: archive
            url: "https://ftp.gnome.org/pub/gnome/sources/pygobject/3.30/pygobject-3.30.1.tar.xz"
            sha256: e1335b70e36885bf1ae207ec1283a369b8fc3e080688046c1edb5a676edc11ce
        modules:
          - name: pycairo
            buildsystem: meson
            sources:
              - type: archive
                url: "https://github.com/pygobject/pycairo/releases/download/v1.17.1/pycairo-1.17.1.tar.gz"
                sha256: 0f0a35ec923d87bc495f6753b1e540fd046d95db56a35250c44089fbce03b698
